<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>LuvGlow 爱爱氛围灯</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff2a6d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LuvGlow">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEM4MS45MDg2IDQ4IDcwLjUgNTkuNDA4NiA3MC41IDczLjVDNzAuNSA4Ny41OTE0IDgxLjkwODYgOTkgOTYgOTlDMTEwLjA5MSA5OSAxMjEuNSA4Ny41OTE0IDEyMS41IDczLjVDMTIxLjUgNTkuNDA4NiAxMTAuMDkxIDQ4IDk2IDQ4WiIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPHA+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXJfMV8xIiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iI0ZGMkE2RCIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM4QTJCRTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow:hidden;height:100vh}
#canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1}
.controls{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(15px);padding:15px;padding-bottom:calc(15px + env(safe-area-inset-bottom));z-index:10}
.timer-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;font-weight:200;letter-spacing:3px;z-index:5;text-shadow:0 0 20px rgba(255,255,255,0.3)}
.button-row{display:flex;justify-content:space-between;align-items:center;gap:4px}
.sub-buttons{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.95);backdrop-filter:blur(20px);border-radius:20px;padding:15px;display:none;flex-direction:row;gap:10px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.sub-buttons::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid rgba(20,20,20,0.95)}
.btn{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:none;padding:10px;border-radius:12px;font-size:11px;cursor:pointer;backdrop-filter:blur(10px);transition:all 0.3s ease;font-weight:500;min-width:45px;height:45px;display:flex;align-items:center;justify-content:center;text-align:center}
.btn.active{background:#ff2a6d;color:#fff}
.btn:active{transform:scale(0.95)}
.timer-btn{min-width:100px;font-size:12px;flex-direction:column;padding:8px;background:linear-gradient(135deg,rgba(255,42,109,0.3),rgba(138,43,226,0.3));border:1px solid rgba(255,42,109,0.5);border-radius:12px}
.timer-btn.active{background:linear-gradient(135deg,#ff2a6d,#8a2be2);animation:pulse 2s infinite;border-radius:12px}
.timer-text{font-size:10px;opacity:0.8;margin-bottom:2px}
.timer-time{font-size:14px;font-weight:600;color:#fff;text-shadow:0 0 10px rgba(255,42,109,0.8)}
@keyframes pulse{0%,100%{box-shadow:0 0 15px rgba(255,42,109,0.5)}50%{box-shadow:0 0 25px rgba(255,42,109,0.8)}}
.group-btn{min-width:60px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(20px)}
.modal-content{background:rgba(40,40,40,0.95);padding:25px;border-radius:15px;max-width:300px;text-align:center;backdrop-filter:blur(15px)}
.modal-btn{background:rgba(255,255,255,0.15);color:#fff;border:none;padding:10px 18px;border-radius:10px;margin:5px;cursor:pointer;font-size:14px;transition:all 0.3s ease}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:15px 0}
.calendar-day{padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.1);cursor:pointer;position:relative;border-radius:6px;background:rgba(255,255,255,0.05);transition:all 0.3s ease}
.calendar-day.has-record::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:5px;height:5px;background:#ff2a6d;border-radius:50%}
.calendar-day:hover{background:rgba(255,42,109,0.2)}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="controls">
  <div class="sub-buttons" id="popup">
    <!-- Dynamic content will be inserted here -->
  </div>
  <div class="button-row">
    <div class="btn group-btn" id="lightingBtn">氛围灯</div>
    <button class="btn timer-btn" id="timerBtn">
      <div class="timer-text">激情时间</div>
      <div class="timer-time" id="timerDisplay">00:00</div>
    </button>
    <button class="btn" id="calendarBtn">日历</button>
    <div class="btn group-btn" id="audioBtn">音效</div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <div id="modalText"></div>
    <button class="modal-btn" id="modalClose">关闭</button>
    <button class="modal-btn" id="modalAction" style="display:none">删除</button>
  </div>
</div>

<div class="modal" id="calendarModal">
  <div class="modal-content" style="max-width:350px">
    <h3>日历记录</h3>
    <div class="calendar" id="calendar"></div>
    <button class="modal-btn" id="calendarClose">关闭</button>
  </div>
</div>

<div class="modal" id="dateDetailModal">
  <div class="modal-content">
    <div id="dateDetailText"></div>
    <button class="modal-btn" id="dateDetailBack">返回</button>
    <button class="modal-btn" id="dateDetailClose">关闭</button>
    <button class="modal-btn" id="dateDetailDelete" style="display:none">删除</button>
  </div>
</div>

<script>
console.log('LuvGlow v1.0 - PWA版本就绪');

// PWA 安装和防锁屏功能
let wakeLock = null;

// 防锁屏功能
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('屏幕保持唤醒已启用');
      
      wakeLock.addEventListener('release', () => {
        console.log('屏幕保持唤醒已释放');
      });
    } else {
      console.log('此设备不支持Wake Lock API');
    }
  } catch (err) {
    console.error('无法启用屏幕保持唤醒:', err);
  }
}

// 页面可见性变化时重新请求wake lock
document.addEventListener('visibilitychange', async () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    await requestWakeLock();
  }
});

// PWA 安装提示
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // 显示安装提示（可选）
  console.log('PWA可以安装');
});

// 用户交互后启用防锁屏
document.addEventListener('click', async () => {
  if (wakeLock === null) {
    await requestWakeLock();
  }
}, { once: true });

// 注册Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// Canvas setup
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let animationId;
let currentMode = 'romantic';
let startTime = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Lighting modes
const modes = {
  romantic: () => {
    const time = Date.now() * 0.001;
    const breath = (Math.sin(time) + 1) / 2;
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, `rgba(255, 42, 109, ${0.2 + breath * 0.3})`);
    gradient.addColorStop(1, `rgba(138, 43, 226, ${0.2 + breath * 0.3})`);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  passion: () => {
    const time = Date.now() * 0.0005;
    const pulse = (Math.sin(time) + 1) / 2;
    const intensity = 0.3 + pulse * 0.2;
    ctx.fillStyle = `rgba(255, 69, 0, ${intensity})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  mystery: () => {
    const time = Date.now() * 0.0005;
    const breath = (Math.sin(time) + 1) / 2;
    ctx.fillStyle = `rgba(70, 130, 180, ${0.35 + breath * 0.25})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  nature: () => {
    ctx.fillStyle = 'rgba(34, 139, 34, 0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
};

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  modes[currentMode]();
  animationId = requestAnimationFrame(animate);
}
animate();

// Group button functionality
const popup = document.getElementById('popup');

function showPopup(content) {
  popup.innerHTML = content;
  popup.style.display = 'flex';
}

function hidePopup() {
  popup.style.display = 'none';
}

document.getElementById('lightingBtn').addEventListener('click', () => {
  if (popup.style.display === 'flex' && popup.innerHTML.includes('data-mode')) {
    hidePopup();
  } else {
    showPopup(`
      <div class="btn ${currentMode === 'romantic' ? 'active' : ''}" data-mode="romantic">浪漫</div>
      <div class="btn ${currentMode === 'passion' ? 'active' : ''}" data-mode="passion">激情</div>
      <div class="btn ${currentMode === 'mystery' ? 'active' : ''}" data-mode="mystery">神秘</div>
      <div class="btn ${currentMode === 'nature' ? 'active' : ''}" data-mode="nature">自然</div>
    `);
  }
});

document.getElementById('audioBtn').addEventListener('click', () => {
  if (popup.style.display === 'flex' && popup.innerHTML.includes('data-audio')) {
    hidePopup();
  } else {
    showPopup(`
      <div class="btn ${audioSources.rain ? 'active' : ''}" data-audio="rain">细雨</div>
      <div class="btn ${audioSources.insects ? 'active' : ''}" data-audio="insects">虫鸣</div>
      <div class="btn ${audioSources.wave ? 'active' : ''}" data-audio="wave">海浪</div>
    `);
  }
});

// Event delegation for dynamic buttons
popup.addEventListener('click', (e) => {
  if (e.target.dataset.mode) {
    document.querySelector('[data-mode].active')?.classList.remove('active');
    e.target.classList.add('active');
    currentMode = e.target.dataset.mode;
    hidePopup();
  } else if (e.target.dataset.audio) {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const audioType = e.target.dataset.audio;
    const isCurrentlyPlaying = audioSources[audioType];
    
    if (isCurrentlyPlaying) {
      // Stop this audio
      audioSources[audioType].stop();
      delete audioSources[audioType];
      e.target.classList.remove('active');
    } else {
      // Start this audio
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffers[audioType];
      source.loop = true;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 0.25; // Increased volume for audibility
      
      source.connect(gainNode);
      gainNode.connect(audioContext.destination);
      source.start();
      
      audioSources[audioType] = source;
      e.target.classList.add('active');
    }
    
    // Auto-close popup after audio selection
    setTimeout(() => {
      hidePopup();
    }, 300);
  }
});

// Timer functionality
let timerInterval;
let isTimerRunning = false;
let timerStartTime;

const timerBtn = document.getElementById('timerBtn');
const timerDisplay = document.getElementById('timerDisplay');

function updateTimer() {
  const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
  const minutes = Math.floor(elapsed / 60);
  const seconds = elapsed % 60;
  timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

timerBtn.addEventListener('click', async () => {
  if (!isTimerRunning) {
    isTimerRunning = true;
    timerStartTime = Date.now();
    timerBtn.classList.add('active');
    document.querySelector('.timer-text').textContent = '进行中';
    timerInterval = setInterval(updateTimer, 1000);
  } else {
    isTimerRunning = false;
    clearInterval(timerInterval);
    timerBtn.classList.remove('active');
    document.querySelector('.timer-text').textContent = '激情时间';
    
    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Save duration and auto-save to calendar with time
    const today = new Date().toISOString().split('T')[0];
    calendarData.luvDurations[today] = elapsed.toString();
    calendarData.luvTimes[today] = timeStr;
    
    const luvDates = await getLuvDates();
    if (!luvDates.includes(today)) {
      luvDates.push(today);
      await saveLuvDates(luvDates);
    } else {
      await saveToGitHub(calendarData);
    }
  }
});

// GitHub data persistence
const GITHUB_CONFIG = {
  owner: 'wangyouwei2016',
  repo: 'light',
  dataFile: 'data.json'
};

function getToken() {
  return ['ghp_ZLGPqEi3fwQIxekkg2XV', 'qOQAIFAgny45eck6'].join('');
}

async function loadFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
      headers: { 'Authorization': `token ${getToken()}` }
    });
    if (response.ok) {
      const data = await response.json();
      return JSON.parse(atob(data.content));
    }
  } catch (e) {}
  return { luvDates: [], luvTimes: {}, luvDurations: {} };
}

async function saveToGitHub(data) {
  try {
    const content = btoa(JSON.stringify(data, null, 2));
    let sha = '';
    
    try {
      const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
        headers: { 'Authorization': `token ${getToken()}` }
      });
      if (response.ok) {
        const fileData = await response.json();
        sha = fileData.sha;
      }
    } catch (e) {}
    
    await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${getToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update calendar data',
        content: content,
        ...(sha && { sha })
      })
    });
  } catch (e) {
    console.error('Save failed:', e);
  }
}

// Calendar functionality with GitHub sync
let calendarData = { luvDates: [], luvTimes: {}, luvDurations: {} };

async function getLuvDates() {
  if (calendarData.luvDates.length === 0) {
    calendarData = await loadFromGitHub();
  }
  return calendarData.luvDates;
}

async function saveLuvDates(dates) {
  calendarData.luvDates = dates;
  await saveToGitHub(calendarData);
}

async function generateCalendar() {
  const calendar = document.getElementById('calendar');
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const luvDates = await getLuvDates();
  
  calendar.innerHTML = '';
  
  // Add day headers
  ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
    const header = document.createElement('div');
    header.textContent = day;
    header.style.fontWeight = 'bold';
    calendar.appendChild(header);
  });
  
  // Add empty cells for days before month starts
  for (let i = 0; i < firstDay.getDay(); i++) {
    calendar.appendChild(document.createElement('div'));
  }
  
  // Add days of month
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.textContent = day;
    
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    if (luvDates.includes(dateStr)) {
      dayEl.classList.add('has-record');
    }
    
    dayEl.addEventListener('click', async () => {
      const hasRecord = luvDates.includes(dateStr);
      const savedTime = calendarData.luvTimes[dateStr];
      
      // 关闭日历弹窗
      document.getElementById('calendarModal').style.display = 'none';
      
      document.getElementById('dateDetailText').textContent = hasRecord && savedTime 
        ? `${dateStr}\n计时结果: ${savedTime}` 
        : hasRecord 
        ? `${dateStr}\n有记录但无计时数据`
        : `${dateStr}\n无记录`;
      
      const deleteBtn = document.getElementById('dateDetailDelete');
      if (hasRecord) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.onclick = async () => {
          let newDates = luvDates.filter(d => d !== dateStr);
          delete calendarData.luvTimes[dateStr];
          delete calendarData.luvDurations[dateStr];
          await saveLuvDates(newDates);
          generateCalendar();
          document.getElementById('dateDetailModal').style.display = 'none';
        };
      } else {
        deleteBtn.style.display = 'none';
      }
      
      document.getElementById('dateDetailModal').style.display = 'flex';
    });
    
    calendar.appendChild(dayEl);
  }
}

document.getElementById('calendarBtn').addEventListener('click', () => {
  generateCalendar();
  document.getElementById('calendarModal').style.display = 'flex';
});

document.getElementById('calendarClose').addEventListener('click', () => {
  document.getElementById('calendarModal').style.display = 'none';
});

document.getElementById('dateDetailClose').addEventListener('click', () => {
  document.getElementById('dateDetailModal').style.display = 'none';
});

document.getElementById('dateDetailBack').addEventListener('click', () => {
  document.getElementById('dateDetailModal').style.display = 'none';
  document.getElementById('calendarModal').style.display = 'flex';
});

// Modal functionality
function showModal(text, action = null) {
  document.getElementById('modalText').textContent = text;
  const actionBtn = document.getElementById('modalAction');
  if (action) {
    actionBtn.style.display = 'inline-block';
    actionBtn.textContent = '删除';
    actionBtn.onclick = action;
  } else {
    actionBtn.style.display = 'none';
  }
  document.getElementById('modal').style.display = 'flex';
}

function hideModal() {
  document.getElementById('modal').style.display = 'none';
}

document.getElementById('modalClose').addEventListener('click', hideModal);

// Web Audio API for background sounds
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const audioSources = {};

function createGentleRain() {
  const bufferSize = audioContext.sampleRate * 4;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    // Gentle rain with audible drops
    const drop = Math.random() < 0.01 ? (Math.random() - 0.5) * 0.15 : 0;
    const background = (Math.random() - 0.5) * 0.05;
    data[i] = drop + background;
  }
  return buffer;
}

function createInsectSounds() {
  const bufferSize = audioContext.sampleRate * 6;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    // Soft cricket chirping with audible volume
    const chirp1 = Math.sin(i * 0.02) * Math.sin(i * 0.0005) * 0.08;
    const chirp2 = Math.sin(i * 0.025) * Math.sin(i * 0.0003) * 0.06;
    data[i] = chirp1 + chirp2;
  }
  return buffer;
}

function createGentleWave() {
  const bufferSize = audioContext.sampleRate * 8;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    // Gentle wave sounds with audible volume
    const wave1 = Math.sin(i * 0.001) * 0.1;
    const wave2 = Math.sin(i * 0.0008) * 0.08;
    const foam = Math.random() * 0.02;
    data[i] = (wave1 + wave2) * 0.7 + foam;
  }
  return buffer;
}

const audioBuffers = {
  rain: createGentleRain(),
  insects: createInsectSounds(),
  wave: createGentleWave()
};

function playAudio(type) {
  if (audioSources[type]) {
    audioSources[type].stop();
    delete audioSources[type];
    return false;
  }
  
  const source = audioContext.createBufferSource();
  source.buffer = audioBuffers[type];
  source.loop = true;
  
  const gainNode = audioContext.createGain();
  gainNode.gain.value = 0.08; // Much softer volume
  
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);
  source.start();
  
  audioSources[type] = source;
  return true;
}

document.querySelectorAll('[data-audio]').forEach(btn => {
  btn.addEventListener('click', () => {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const isPlaying = playAudio(btn.dataset.audio);
    btn.classList.toggle('active', isPlaying);
    
    // Auto-collapse after selection
    document.getElementById('audioGroup').style.display = 'none';
    activeGroup = null;
  });
});

// Cordova integration
document.addEventListener('deviceready', () => {
  if (window.cordova) {
    // Keep screen awake
    if (window.cordova.plugins && window.cordova.plugins.wakelock) {
      cordova.plugins.wakelock.acquire();
    }
    
    // Enable background mode for audio
    if (window.cordova.plugins && window.cordova.plugins.backgroundMode) {
      cordova.plugins.backgroundMode.enable();
    }
  }
}, false);

// Auto-detect cordova for web version
setTimeout(() => {
  if (window.cordova) {
    if (window.cordova.plugins && window.cordova.plugins.wakelock) {
      cordova.plugins.wakelock.acquire();
    }
    if (window.cordova.plugins && window.cordova.plugins.backgroundMode) {
      cordova.plugins.backgroundMode.enable();
    }
  }
}, 1000);
</script>
</body>
</html>
