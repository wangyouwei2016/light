<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>LuvGlow 爱爱氛围灯</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow:hidden;height:100vh}
#canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1}
.controls{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(15px);padding:15px;padding-bottom:calc(15px + env(safe-area-inset-bottom));z-index:10}
.timer-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;font-weight:200;letter-spacing:3px;z-index:5;text-shadow:0 0 20px rgba(255,255,255,0.3)}
.button-row{display:flex;justify-content:space-between;align-items:center;gap:4px}
.sub-buttons{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.95);backdrop-filter:blur(20px);border-radius:20px;padding:15px;display:none;flex-direction:row;gap:10px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.sub-buttons::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid rgba(20,20,20,0.95)}
.btn{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:none;padding:10px;border-radius:12px;font-size:11px;cursor:pointer;backdrop-filter:blur(10px);transition:all 0.3s ease;font-weight:500;min-width:45px;height:45px;display:flex;align-items:center;justify-content:center;text-align:center}
.btn.active{background:#ff2a6d;color:#fff}
.btn:active{transform:scale(0.95)}
.timer-btn{min-width:100px;font-size:12px;flex-direction:column;padding:8px;background:linear-gradient(135deg,rgba(255,42,109,0.3),rgba(138,43,226,0.3));border:1px solid rgba(255,42,109,0.5)}
.timer-btn.active{background:linear-gradient(135deg,#ff2a6d,#8a2be2);animation:pulse 2s infinite}
.timer-text{font-size:10px;opacity:0.8;margin-bottom:2px}
.timer-time{font-size:14px;font-weight:600;color:#fff;text-shadow:0 0 10px rgba(255,42,109,0.8)}
@keyframes pulse{0%,100%{box-shadow:0 0 15px rgba(255,42,109,0.5)}50%{box-shadow:0 0 25px rgba(255,42,109,0.8)}}
.group-btn{min-width:60px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(20px)}
.modal-content{background:rgba(40,40,40,0.95);padding:25px;border-radius:15px;max-width:300px;text-align:center;backdrop-filter:blur(15px)}
.modal-btn{background:rgba(255,255,255,0.15);color:#fff;border:none;padding:10px 18px;border-radius:10px;margin:5px;cursor:pointer;font-size:14px;transition:all 0.3s ease}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:15px 0}
.calendar-day{padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.1);cursor:pointer;position:relative;border-radius:6px;background:rgba(255,255,255,0.05);transition:all 0.3s ease}
.calendar-day.has-record::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:5px;height:5px;background:#ff2a6d;border-radius:50%}
.calendar-day:hover{background:rgba(255,42,109,0.2)}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div class="controls">
  <div class="sub-buttons" id="popup">
    <!-- Dynamic content will be inserted here -->
  </div>
  <div class="button-row">
    <div class="btn group-btn" id="lightingBtn">氛围灯</div>
    <button class="btn timer-btn" id="timerBtn">
      <div class="timer-text">激情时间</div>
      <div class="timer-time" id="timerDisplay">00:00</div>
    </button>
    <button class="btn" id="calendarBtn">日历</button>
    <div class="btn group-btn" id="audioBtn">音效</div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <div id="modalText"></div>
    <button class="modal-btn" id="modalClose">关闭</button>
    <button class="modal-btn" id="modalAction" style="display:none">删除</button>
  </div>
</div>

<div class="modal" id="calendarModal">
  <div class="modal-content" style="max-width:350px">
    <h3>日历记录</h3>
    <div class="calendar" id="calendar"></div>
    <button class="modal-btn" id="calendarClose">关闭</button>
  </div>
</div>

<script>
console.log('LuvGlow v1.0 - H5 套壳就绪');

// Canvas setup
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let animationId;
let currentMode = 'romantic';
let startTime = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Lighting modes
const modes = {
  romantic: () => {
    const time = Date.now() * 0.001;
    const breath = (Math.sin(time) + 1) / 2;
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, `rgba(255, 42, 109, ${0.2 + breath * 0.3})`);
    gradient.addColorStop(1, `rgba(138, 43, 226, ${0.2 + breath * 0.3})`);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  passion: () => {
    const time = Date.now() * 0.003;
    const pulse = (Math.sin(time) + 1) / 2;
    const intensity = 0.3 + pulse * 0.4;
    ctx.fillStyle = `rgba(255, 69, 0, ${intensity})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  mystery: () => {
    const time = Date.now() * 0.0005;
    const breath = (Math.sin(time) + 1) / 2;
    ctx.fillStyle = `rgba(25, 25, 112, ${0.15 + breath * 0.35})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  },
  nature: () => {
    ctx.fillStyle = 'rgba(34, 139, 34, 0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
};

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  modes[currentMode]();
  animationId = requestAnimationFrame(animate);
}
animate();

// Group button functionality
const popup = document.getElementById('popup');

function showPopup(content) {
  popup.innerHTML = content;
  popup.style.display = 'flex';
}

function hidePopup() {
  popup.style.display = 'none';
}

document.getElementById('lightingBtn').addEventListener('click', () => {
  if (popup.style.display === 'flex' && popup.innerHTML.includes('data-mode')) {
    hidePopup();
  } else {
    showPopup(`
      <div class="btn ${currentMode === 'romantic' ? 'active' : ''}" data-mode="romantic">浪漫</div>
      <div class="btn ${currentMode === 'passion' ? 'active' : ''}" data-mode="passion">激情</div>
      <div class="btn ${currentMode === 'mystery' ? 'active' : ''}" data-mode="mystery">神秘</div>
      <div class="btn ${currentMode === 'nature' ? 'active' : ''}" data-mode="nature">自然</div>
    `);
  }
});

document.getElementById('audioBtn').addEventListener('click', () => {
  if (popup.style.display === 'flex' && popup.innerHTML.includes('data-audio')) {
    hidePopup();
  } else {
    showPopup(`
      <div class="btn ${audioSources.rain ? 'active' : ''}" data-audio="rain">细雨</div>
      <div class="btn ${audioSources.insects ? 'active' : ''}" data-audio="insects">虫鸣</div>
      <div class="btn ${audioSources.wave ? 'active' : ''}" data-audio="wave">海浪</div>
    `);
  }
});

// Event delegation for dynamic buttons
popup.addEventListener('click', (e) => {
  if (e.target.dataset.mode) {
    document.querySelector('[data-mode].active')?.classList.remove('active');
    e.target.classList.add('active');
    currentMode = e.target.dataset.mode;
    hidePopup();
  } else if (e.target.dataset.audio) {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const audioType = e.target.dataset.audio;
    const isCurrentlyPlaying = audioSources[audioType];
    
    if (isCurrentlyPlaying) {
      // Stop this audio
      audioSources[audioType].stop();
      delete audioSources[audioType];
      e.target.classList.remove('active');
    } else {
      // Start this audio
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffers[audioType];
      source.loop = true;
      
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 0.25; // Increased volume for audibility
      
      source.connect(gainNode);
      gainNode.connect(audioContext.destination);
      source.start();
      
      audioSources[audioType] = source;
      e.target.classList.add('active');
    }
    
    // Auto-close popup after audio selection
    setTimeout(() => {
      hidePopup();
    }, 300);
  }
});

// Timer functionality
let timerInterval;
let isTimerRunning = false;
let timerStartTime;

const timerBtn = document.getElementById('timerBtn');
const timerDisplay = document.getElementById('timerDisplay');

function updateTimer() {
  const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
  const minutes = Math.floor(elapsed / 60);
  const seconds = elapsed % 60;
  timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

timerBtn.addEventListener('click', () => {
  if (!isTimerRunning) {
    isTimerRunning = true;
    timerStartTime = Date.now();
    timerBtn.classList.add('active');
    document.querySelector('.timer-text').textContent = '进行中';
    timerInterval = setInterval(updateTimer, 1000);
  } else {
    isTimerRunning = false;
    clearInterval(timerInterval);
    timerBtn.classList.remove('active');
    document.querySelector('.timer-text').textContent = '激情时间';
    
    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Save duration and auto-save to calendar with time
    const today = new Date().toISOString().split('T')[0];
    localStorage.setItem(`luvDuration_${today}`, elapsed.toString());
    
    const luvDates = getLuvDates();
    if (!luvDates.includes(today)) {
      luvDates.push(today);
      saveLuvDates(luvDates);
    }
    
    // Store time for calendar display
    localStorage.setItem(`luvTime_${today}`, timeStr);
    
    // Keep showing the final time instead of resetting
    // timerDisplay.textContent = '00:00';
  }
});

// Calendar functionality
function getLuvDates() {
  const dates = localStorage.getItem('luvDates');
  return dates ? JSON.parse(dates) : [];
}

function saveLuvDates(dates) {
  localStorage.setItem('luvDates', JSON.stringify(dates));
}

function generateCalendar() {
  const calendar = document.getElementById('calendar');
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const luvDates = getLuvDates();
  
  calendar.innerHTML = '';
  
  // Add day headers
  ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
    const header = document.createElement('div');
    header.textContent = day;
    header.style.fontWeight = 'bold';
    calendar.appendChild(header);
  });
  
  // Add empty cells for days before month starts
  for (let i = 0; i < firstDay.getDay(); i++) {
    calendar.appendChild(document.createElement('div'));
  }
  
  // Add days of month
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.textContent = day;
    
    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    if (luvDates.includes(dateStr)) {
      dayEl.classList.add('has-record');
    }
    
    dayEl.addEventListener('click', () => {
      const hasRecord = luvDates.includes(dateStr);
      const savedTime = localStorage.getItem(`luvTime_${dateStr}`);
      
      if (hasRecord && savedTime) {
        showModal(`${dateStr}\n时长: ${savedTime}`, () => {
          let newDates = luvDates.filter(d => d !== dateStr);
          saveLuvDates(newDates);
          localStorage.removeItem(`luvTime_${dateStr}`);
          localStorage.removeItem(`luvDuration_${dateStr}`);
          generateCalendar();
          hideModal();
        });
      } else if (hasRecord) {
        showModal(`删除记录 ${dateStr}?`, () => {
          let newDates = luvDates.filter(d => d !== dateStr);
          saveLuvDates(newDates);
          generateCalendar();
          hideModal();
        });
      } else {
        showModal(`添加记录 ${dateStr}?`, () => {
          const newDates = [...luvDates, dateStr];
          saveLuvDates(newDates);
          generateCalendar();
          hideModal();
        });
      }
    });
    
    calendar.appendChild(dayEl);
  }
}

document.getElementById('calendarBtn').addEventListener('click', () => {
  generateCalendar();
  document.getElementById('calendarModal').style.display = 'flex';
});

document.getElementById('calendarClose').addEventListener('click', () => {
  document.getElementById('calendarModal').style.display = 'none';
});

// Modal functionality
function showModal(text, action = null) {
  document.getElementById('modalText').textContent = text;
  const actionBtn = document.getElementById('modalAction');
  if (action) {
    actionBtn.style.display = 'inline-block';
    actionBtn.onclick = action;
  } else {
    actionBtn.style.display = 'none';
  }
  document.getElementById('modal').style.display = 'flex';
}

function hideModal() {
  document.getElementById('modal').style.display = 'none';
}

document.getElementById('modalClose').addEventListener('click', hideModal);

// Web Audio API for background sounds
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const audioSources = {};

function createGentleRain() {
  const bufferSize = audioContext.sampleRate * 4;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) {
    // Gentle rain with audible drops
    const drop = Math.random() < 0.01 ? (Math.random() - 0.5) * 0.15 : 0;
    const background = (Math.random() - 0.5) * 0.05;
    data[i] = drop + background;
  }
  return buffer;
}

function createInsectSounds() {
  const bufferSize = audioContext.sampleRate * 6;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    // Soft cricket chirping with audible volume
    const chirp1 = Math.sin(i * 0.02) * Math.sin(i * 0.0005) * 0.08;
    const chirp2 = Math.sin(i * 0.025) * Math.sin(i * 0.0003) * 0.06;
    data[i] = chirp1 + chirp2;
  }
  return buffer;
}

function createGentleWave() {
  const bufferSize = audioContext.sampleRate * 8;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    // Gentle wave sounds with audible volume
    const wave1 = Math.sin(i * 0.001) * 0.1;
    const wave2 = Math.sin(i * 0.0008) * 0.08;
    const foam = Math.random() * 0.02;
    data[i] = (wave1 + wave2) * 0.7 + foam;
  }
  return buffer;
}

const audioBuffers = {
  rain: createGentleRain(),
  insects: createInsectSounds(),
  wave: createGentleWave()
};

function playAudio(type) {
  if (audioSources[type]) {
    audioSources[type].stop();
    delete audioSources[type];
    return false;
  }
  
  const source = audioContext.createBufferSource();
  source.buffer = audioBuffers[type];
  source.loop = true;
  
  const gainNode = audioContext.createGain();
  gainNode.gain.value = 0.08; // Much softer volume
  
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);
  source.start();
  
  audioSources[type] = source;
  return true;
}

document.querySelectorAll('[data-audio]').forEach(btn => {
  btn.addEventListener('click', () => {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const isPlaying = playAudio(btn.dataset.audio);
    btn.classList.toggle('active', isPlaying);
    
    // Auto-collapse after selection
    document.getElementById('audioGroup').style.display = 'none';
    activeGroup = null;
  });
});

// Cordova integration
document.addEventListener('deviceready', () => {
  if (window.cordova) {
    // Keep screen awake
    if (window.cordova.plugins && window.cordova.plugins.wakelock) {
      cordova.plugins.wakelock.acquire();
    }
    
    // Enable background mode for audio
    if (window.cordova.plugins && window.cordova.plugins.backgroundMode) {
      cordova.plugins.backgroundMode.enable();
    }
  }
}, false);

// Auto-detect cordova for web version
setTimeout(() => {
  if (window.cordova) {
    if (window.cordova.plugins && window.cordova.plugins.wakelock) {
      cordova.plugins.wakelock.acquire();
    }
    if (window.cordova.plugins && window.cordova.plugins.backgroundMode) {
      cordova.plugins.backgroundMode.enable();
    }
  }
}, 1000);
</script>
</body>
</html>
